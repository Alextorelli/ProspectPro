revoke delete on table "public"."campaign_request_snapshots" from "anon";

revoke insert on table "public"."campaign_request_snapshots" from "anon";

revoke references on table "public"."campaign_request_snapshots" from "anon";

revoke select on table "public"."campaign_request_snapshots" from "anon";

revoke trigger on table "public"."campaign_request_snapshots" from "anon";

revoke truncate on table "public"."campaign_request_snapshots" from "anon";

revoke update on table "public"."campaign_request_snapshots" from "anon";

revoke delete on table "public"."campaign_request_snapshots" from "authenticated";

revoke insert on table "public"."campaign_request_snapshots" from "authenticated";

revoke references on table "public"."campaign_request_snapshots" from "authenticated";

revoke select on table "public"."campaign_request_snapshots" from "authenticated";

revoke trigger on table "public"."campaign_request_snapshots" from "authenticated";

revoke truncate on table "public"."campaign_request_snapshots" from "authenticated";

revoke update on table "public"."campaign_request_snapshots" from "authenticated";

revoke delete on table "public"."campaign_request_snapshots" from "service_role";

revoke insert on table "public"."campaign_request_snapshots" from "service_role";

revoke references on table "public"."campaign_request_snapshots" from "service_role";

revoke select on table "public"."campaign_request_snapshots" from "service_role";

revoke trigger on table "public"."campaign_request_snapshots" from "service_role";

revoke truncate on table "public"."campaign_request_snapshots" from "service_role";

revoke update on table "public"."campaign_request_snapshots" from "service_role";

revoke delete on table "public"."campaigns" from "anon";

revoke insert on table "public"."campaigns" from "anon";

revoke references on table "public"."campaigns" from "anon";

revoke select on table "public"."campaigns" from "anon";

revoke trigger on table "public"."campaigns" from "anon";

revoke truncate on table "public"."campaigns" from "anon";

revoke update on table "public"."campaigns" from "anon";

revoke delete on table "public"."campaigns" from "authenticated";

revoke insert on table "public"."campaigns" from "authenticated";

revoke references on table "public"."campaigns" from "authenticated";

revoke select on table "public"."campaigns" from "authenticated";

revoke trigger on table "public"."campaigns" from "authenticated";

revoke truncate on table "public"."campaigns" from "authenticated";

revoke update on table "public"."campaigns" from "authenticated";

revoke delete on table "public"."campaigns" from "service_role";

revoke insert on table "public"."campaigns" from "service_role";

revoke references on table "public"."campaigns" from "service_role";

revoke select on table "public"."campaigns" from "service_role";

revoke trigger on table "public"."campaigns" from "service_role";

revoke truncate on table "public"."campaigns" from "service_role";

revoke update on table "public"."campaigns" from "service_role";

revoke delete on table "public"."dashboard_exports" from "anon";

revoke insert on table "public"."dashboard_exports" from "anon";

revoke references on table "public"."dashboard_exports" from "anon";

revoke select on table "public"."dashboard_exports" from "anon";

revoke trigger on table "public"."dashboard_exports" from "anon";

revoke truncate on table "public"."dashboard_exports" from "anon";

revoke update on table "public"."dashboard_exports" from "anon";

revoke delete on table "public"."dashboard_exports" from "authenticated";

revoke insert on table "public"."dashboard_exports" from "authenticated";

revoke references on table "public"."dashboard_exports" from "authenticated";

revoke select on table "public"."dashboard_exports" from "authenticated";

revoke trigger on table "public"."dashboard_exports" from "authenticated";

revoke truncate on table "public"."dashboard_exports" from "authenticated";

revoke update on table "public"."dashboard_exports" from "authenticated";

revoke delete on table "public"."dashboard_exports" from "service_role";

revoke insert on table "public"."dashboard_exports" from "service_role";

revoke references on table "public"."dashboard_exports" from "service_role";

revoke select on table "public"."dashboard_exports" from "service_role";

revoke trigger on table "public"."dashboard_exports" from "service_role";

revoke truncate on table "public"."dashboard_exports" from "service_role";

revoke update on table "public"."dashboard_exports" from "service_role";

revoke delete on table "public"."discovery_jobs" from "anon";

revoke insert on table "public"."discovery_jobs" from "anon";

revoke references on table "public"."discovery_jobs" from "anon";

revoke select on table "public"."discovery_jobs" from "anon";

revoke trigger on table "public"."discovery_jobs" from "anon";

revoke truncate on table "public"."discovery_jobs" from "anon";

revoke update on table "public"."discovery_jobs" from "anon";

revoke delete on table "public"."discovery_jobs" from "authenticated";

revoke insert on table "public"."discovery_jobs" from "authenticated";

revoke references on table "public"."discovery_jobs" from "authenticated";

revoke select on table "public"."discovery_jobs" from "authenticated";

revoke trigger on table "public"."discovery_jobs" from "authenticated";

revoke truncate on table "public"."discovery_jobs" from "authenticated";

revoke update on table "public"."discovery_jobs" from "authenticated";

revoke delete on table "public"."discovery_jobs" from "service_role";

revoke insert on table "public"."discovery_jobs" from "service_role";

revoke references on table "public"."discovery_jobs" from "service_role";

revoke select on table "public"."discovery_jobs" from "service_role";

revoke trigger on table "public"."discovery_jobs" from "service_role";

revoke truncate on table "public"."discovery_jobs" from "service_role";

revoke update on table "public"."discovery_jobs" from "service_role";

revoke delete on table "public"."enhanced_api_usage" from "anon";

revoke insert on table "public"."enhanced_api_usage" from "anon";

revoke references on table "public"."enhanced_api_usage" from "anon";

revoke select on table "public"."enhanced_api_usage" from "anon";

revoke trigger on table "public"."enhanced_api_usage" from "anon";

revoke truncate on table "public"."enhanced_api_usage" from "anon";

revoke update on table "public"."enhanced_api_usage" from "anon";

revoke delete on table "public"."enhanced_api_usage" from "authenticated";

revoke insert on table "public"."enhanced_api_usage" from "authenticated";

revoke references on table "public"."enhanced_api_usage" from "authenticated";

revoke select on table "public"."enhanced_api_usage" from "authenticated";

revoke trigger on table "public"."enhanced_api_usage" from "authenticated";

revoke truncate on table "public"."enhanced_api_usage" from "authenticated";

revoke update on table "public"."enhanced_api_usage" from "authenticated";

revoke delete on table "public"."enhanced_api_usage" from "service_role";

revoke insert on table "public"."enhanced_api_usage" from "service_role";

revoke references on table "public"."enhanced_api_usage" from "service_role";

revoke select on table "public"."enhanced_api_usage" from "service_role";

revoke trigger on table "public"."enhanced_api_usage" from "service_role";

revoke truncate on table "public"."enhanced_api_usage" from "service_role";

revoke update on table "public"."enhanced_api_usage" from "service_role";

revoke delete on table "public"."enhanced_leads" from "anon";

revoke insert on table "public"."enhanced_leads" from "anon";

revoke references on table "public"."enhanced_leads" from "anon";

revoke select on table "public"."enhanced_leads" from "anon";

revoke trigger on table "public"."enhanced_leads" from "anon";

revoke truncate on table "public"."enhanced_leads" from "anon";

revoke update on table "public"."enhanced_leads" from "anon";

revoke delete on table "public"."enhanced_leads" from "authenticated";

revoke insert on table "public"."enhanced_leads" from "authenticated";

revoke references on table "public"."enhanced_leads" from "authenticated";

revoke select on table "public"."enhanced_leads" from "authenticated";

revoke trigger on table "public"."enhanced_leads" from "authenticated";

revoke truncate on table "public"."enhanced_leads" from "authenticated";

revoke update on table "public"."enhanced_leads" from "authenticated";

revoke delete on table "public"."enhanced_leads" from "service_role";

revoke insert on table "public"."enhanced_leads" from "service_role";

revoke references on table "public"."enhanced_leads" from "service_role";

revoke select on table "public"."enhanced_leads" from "service_role";

revoke trigger on table "public"."enhanced_leads" from "service_role";

revoke truncate on table "public"."enhanced_leads" from "service_role";

revoke update on table "public"."enhanced_leads" from "service_role";

revoke delete on table "public"."enrichment_cache" from "anon";

revoke insert on table "public"."enrichment_cache" from "anon";

revoke references on table "public"."enrichment_cache" from "anon";

revoke select on table "public"."enrichment_cache" from "anon";

revoke trigger on table "public"."enrichment_cache" from "anon";

revoke truncate on table "public"."enrichment_cache" from "anon";

revoke update on table "public"."enrichment_cache" from "anon";

revoke delete on table "public"."enrichment_cache" from "authenticated";

revoke insert on table "public"."enrichment_cache" from "authenticated";

revoke references on table "public"."enrichment_cache" from "authenticated";

revoke select on table "public"."enrichment_cache" from "authenticated";

revoke trigger on table "public"."enrichment_cache" from "authenticated";

revoke truncate on table "public"."enrichment_cache" from "authenticated";

revoke update on table "public"."enrichment_cache" from "authenticated";

revoke delete on table "public"."enrichment_cache" from "service_role";

revoke insert on table "public"."enrichment_cache" from "service_role";

revoke references on table "public"."enrichment_cache" from "service_role";

revoke select on table "public"."enrichment_cache" from "service_role";

revoke trigger on table "public"."enrichment_cache" from "service_role";

revoke truncate on table "public"."enrichment_cache" from "service_role";

revoke update on table "public"."enrichment_cache" from "service_role";

revoke delete on table "public"."enrichment_cache_stats" from "anon";

revoke insert on table "public"."enrichment_cache_stats" from "anon";

revoke references on table "public"."enrichment_cache_stats" from "anon";

revoke select on table "public"."enrichment_cache_stats" from "anon";

revoke trigger on table "public"."enrichment_cache_stats" from "anon";

revoke truncate on table "public"."enrichment_cache_stats" from "anon";

revoke update on table "public"."enrichment_cache_stats" from "anon";

revoke delete on table "public"."enrichment_cache_stats" from "authenticated";

revoke insert on table "public"."enrichment_cache_stats" from "authenticated";

revoke references on table "public"."enrichment_cache_stats" from "authenticated";

revoke select on table "public"."enrichment_cache_stats" from "authenticated";

revoke trigger on table "public"."enrichment_cache_stats" from "authenticated";

revoke truncate on table "public"."enrichment_cache_stats" from "authenticated";

revoke update on table "public"."enrichment_cache_stats" from "authenticated";

revoke delete on table "public"."enrichment_cache_stats" from "service_role";

revoke insert on table "public"."enrichment_cache_stats" from "service_role";

revoke references on table "public"."enrichment_cache_stats" from "service_role";

revoke select on table "public"."enrichment_cache_stats" from "service_role";

revoke trigger on table "public"."enrichment_cache_stats" from "service_role";

revoke truncate on table "public"."enrichment_cache_stats" from "service_role";

revoke update on table "public"."enrichment_cache_stats" from "service_role";

revoke delete on table "public"."function_logs" from "anon";

revoke insert on table "public"."function_logs" from "anon";

revoke references on table "public"."function_logs" from "anon";

revoke select on table "public"."function_logs" from "anon";

revoke trigger on table "public"."function_logs" from "anon";

revoke truncate on table "public"."function_logs" from "anon";

revoke update on table "public"."function_logs" from "anon";

revoke delete on table "public"."function_logs" from "authenticated";

revoke insert on table "public"."function_logs" from "authenticated";

revoke references on table "public"."function_logs" from "authenticated";

revoke select on table "public"."function_logs" from "authenticated";

revoke trigger on table "public"."function_logs" from "authenticated";

revoke truncate on table "public"."function_logs" from "authenticated";

revoke update on table "public"."function_logs" from "authenticated";

revoke delete on table "public"."function_logs" from "service_role";

revoke insert on table "public"."function_logs" from "service_role";

revoke references on table "public"."function_logs" from "service_role";

revoke select on table "public"."function_logs" from "service_role";

revoke trigger on table "public"."function_logs" from "service_role";

revoke truncate on table "public"."function_logs" from "service_role";

revoke update on table "public"."function_logs" from "service_role";

revoke delete on table "public"."lead_fingerprints" from "anon";

revoke insert on table "public"."lead_fingerprints" from "anon";

revoke references on table "public"."lead_fingerprints" from "anon";

revoke select on table "public"."lead_fingerprints" from "anon";

revoke trigger on table "public"."lead_fingerprints" from "anon";

revoke truncate on table "public"."lead_fingerprints" from "anon";

revoke update on table "public"."lead_fingerprints" from "anon";

revoke delete on table "public"."lead_fingerprints" from "authenticated";

revoke insert on table "public"."lead_fingerprints" from "authenticated";

revoke references on table "public"."lead_fingerprints" from "authenticated";

revoke select on table "public"."lead_fingerprints" from "authenticated";

revoke trigger on table "public"."lead_fingerprints" from "authenticated";

revoke truncate on table "public"."lead_fingerprints" from "authenticated";

revoke update on table "public"."lead_fingerprints" from "authenticated";

revoke delete on table "public"."lead_fingerprints" from "service_role";

revoke insert on table "public"."lead_fingerprints" from "service_role";

revoke references on table "public"."lead_fingerprints" from "service_role";

revoke select on table "public"."lead_fingerprints" from "service_role";

revoke trigger on table "public"."lead_fingerprints" from "service_role";

revoke truncate on table "public"."lead_fingerprints" from "service_role";

revoke update on table "public"."lead_fingerprints" from "service_role";

revoke delete on table "public"."leads" from "anon";

revoke insert on table "public"."leads" from "anon";

revoke references on table "public"."leads" from "anon";

revoke select on table "public"."leads" from "anon";

revoke trigger on table "public"."leads" from "anon";

revoke truncate on table "public"."leads" from "anon";

revoke update on table "public"."leads" from "anon";

revoke delete on table "public"."leads" from "authenticated";

revoke insert on table "public"."leads" from "authenticated";

revoke references on table "public"."leads" from "authenticated";

revoke select on table "public"."leads" from "authenticated";

revoke trigger on table "public"."leads" from "authenticated";

revoke truncate on table "public"."leads" from "authenticated";

revoke update on table "public"."leads" from "authenticated";

revoke delete on table "public"."leads" from "service_role";

revoke insert on table "public"."leads" from "service_role";

revoke references on table "public"."leads" from "service_role";

revoke select on table "public"."leads" from "service_role";

revoke trigger on table "public"."leads" from "service_role";

revoke truncate on table "public"."leads" from "service_role";

revoke update on table "public"."leads" from "service_role";

revoke delete on table "public"."payment_methods" from "anon";

revoke insert on table "public"."payment_methods" from "anon";

revoke references on table "public"."payment_methods" from "anon";

revoke select on table "public"."payment_methods" from "anon";

revoke trigger on table "public"."payment_methods" from "anon";

revoke truncate on table "public"."payment_methods" from "anon";

revoke update on table "public"."payment_methods" from "anon";

revoke delete on table "public"."payment_methods" from "authenticated";

revoke insert on table "public"."payment_methods" from "authenticated";

revoke references on table "public"."payment_methods" from "authenticated";

revoke select on table "public"."payment_methods" from "authenticated";

revoke trigger on table "public"."payment_methods" from "authenticated";

revoke truncate on table "public"."payment_methods" from "authenticated";

revoke update on table "public"."payment_methods" from "authenticated";

revoke delete on table "public"."payment_methods" from "service_role";

revoke insert on table "public"."payment_methods" from "service_role";

revoke references on table "public"."payment_methods" from "service_role";

revoke select on table "public"."payment_methods" from "service_role";

revoke trigger on table "public"."payment_methods" from "service_role";

revoke truncate on table "public"."payment_methods" from "service_role";

revoke update on table "public"."payment_methods" from "service_role";

revoke delete on table "public"."payment_transactions" from "anon";

revoke insert on table "public"."payment_transactions" from "anon";

revoke references on table "public"."payment_transactions" from "anon";

revoke select on table "public"."payment_transactions" from "anon";

revoke trigger on table "public"."payment_transactions" from "anon";

revoke truncate on table "public"."payment_transactions" from "anon";

revoke update on table "public"."payment_transactions" from "anon";

revoke delete on table "public"."payment_transactions" from "authenticated";

revoke insert on table "public"."payment_transactions" from "authenticated";

revoke references on table "public"."payment_transactions" from "authenticated";

revoke select on table "public"."payment_transactions" from "authenticated";

revoke trigger on table "public"."payment_transactions" from "authenticated";

revoke truncate on table "public"."payment_transactions" from "authenticated";

revoke update on table "public"."payment_transactions" from "authenticated";

revoke delete on table "public"."payment_transactions" from "service_role";

revoke insert on table "public"."payment_transactions" from "service_role";

revoke references on table "public"."payment_transactions" from "service_role";

revoke select on table "public"."payment_transactions" from "service_role";

revoke trigger on table "public"."payment_transactions" from "service_role";

revoke truncate on table "public"."payment_transactions" from "service_role";

revoke update on table "public"."payment_transactions" from "service_role";

revoke delete on table "public"."subscription_tiers" from "anon";

revoke insert on table "public"."subscription_tiers" from "anon";

revoke references on table "public"."subscription_tiers" from "anon";

revoke select on table "public"."subscription_tiers" from "anon";

revoke trigger on table "public"."subscription_tiers" from "anon";

revoke truncate on table "public"."subscription_tiers" from "anon";

revoke update on table "public"."subscription_tiers" from "anon";

revoke delete on table "public"."subscription_tiers" from "authenticated";

revoke insert on table "public"."subscription_tiers" from "authenticated";

revoke references on table "public"."subscription_tiers" from "authenticated";

revoke select on table "public"."subscription_tiers" from "authenticated";

revoke trigger on table "public"."subscription_tiers" from "authenticated";

revoke truncate on table "public"."subscription_tiers" from "authenticated";

revoke update on table "public"."subscription_tiers" from "authenticated";

revoke delete on table "public"."subscription_tiers" from "service_role";

revoke insert on table "public"."subscription_tiers" from "service_role";

revoke references on table "public"."subscription_tiers" from "service_role";

revoke select on table "public"."subscription_tiers" from "service_role";

revoke trigger on table "public"."subscription_tiers" from "service_role";

revoke truncate on table "public"."subscription_tiers" from "service_role";

revoke update on table "public"."subscription_tiers" from "service_role";

revoke delete on table "public"."usage_logs" from "anon";

revoke insert on table "public"."usage_logs" from "anon";

revoke references on table "public"."usage_logs" from "anon";

revoke select on table "public"."usage_logs" from "anon";

revoke trigger on table "public"."usage_logs" from "anon";

revoke truncate on table "public"."usage_logs" from "anon";

revoke update on table "public"."usage_logs" from "anon";

revoke delete on table "public"."usage_logs" from "authenticated";

revoke insert on table "public"."usage_logs" from "authenticated";

revoke references on table "public"."usage_logs" from "authenticated";

revoke select on table "public"."usage_logs" from "authenticated";

revoke trigger on table "public"."usage_logs" from "authenticated";

revoke truncate on table "public"."usage_logs" from "authenticated";

revoke update on table "public"."usage_logs" from "authenticated";

revoke delete on table "public"."usage_logs" from "service_role";

revoke insert on table "public"."usage_logs" from "service_role";

revoke references on table "public"."usage_logs" from "service_role";

revoke select on table "public"."usage_logs" from "service_role";

revoke trigger on table "public"."usage_logs" from "service_role";

revoke truncate on table "public"."usage_logs" from "service_role";

revoke update on table "public"."usage_logs" from "service_role";

revoke delete on table "public"."user_campaign_results" from "anon";

revoke insert on table "public"."user_campaign_results" from "anon";

revoke references on table "public"."user_campaign_results" from "anon";

revoke select on table "public"."user_campaign_results" from "anon";

revoke trigger on table "public"."user_campaign_results" from "anon";

revoke truncate on table "public"."user_campaign_results" from "anon";

revoke update on table "public"."user_campaign_results" from "anon";

revoke delete on table "public"."user_campaign_results" from "authenticated";

revoke insert on table "public"."user_campaign_results" from "authenticated";

revoke references on table "public"."user_campaign_results" from "authenticated";

revoke select on table "public"."user_campaign_results" from "authenticated";

revoke trigger on table "public"."user_campaign_results" from "authenticated";

revoke truncate on table "public"."user_campaign_results" from "authenticated";

revoke update on table "public"."user_campaign_results" from "authenticated";

revoke delete on table "public"."user_campaign_results" from "service_role";

revoke insert on table "public"."user_campaign_results" from "service_role";

revoke references on table "public"."user_campaign_results" from "service_role";

revoke select on table "public"."user_campaign_results" from "service_role";

revoke trigger on table "public"."user_campaign_results" from "service_role";

revoke truncate on table "public"."user_campaign_results" from "service_role";

revoke update on table "public"."user_campaign_results" from "service_role";

revoke delete on table "public"."user_profiles" from "anon";

revoke insert on table "public"."user_profiles" from "anon";

revoke references on table "public"."user_profiles" from "anon";

revoke select on table "public"."user_profiles" from "anon";

revoke trigger on table "public"."user_profiles" from "anon";

revoke truncate on table "public"."user_profiles" from "anon";

revoke update on table "public"."user_profiles" from "anon";

revoke delete on table "public"."user_profiles" from "authenticated";

revoke insert on table "public"."user_profiles" from "authenticated";

revoke references on table "public"."user_profiles" from "authenticated";

revoke select on table "public"."user_profiles" from "authenticated";

revoke trigger on table "public"."user_profiles" from "authenticated";

revoke truncate on table "public"."user_profiles" from "authenticated";

revoke update on table "public"."user_profiles" from "authenticated";

revoke delete on table "public"."user_profiles" from "service_role";

revoke insert on table "public"."user_profiles" from "service_role";

revoke references on table "public"."user_profiles" from "service_role";

revoke select on table "public"."user_profiles" from "service_role";

revoke trigger on table "public"."user_profiles" from "service_role";

revoke truncate on table "public"."user_profiles" from "service_role";

revoke update on table "public"."user_profiles" from "service_role";

revoke delete on table "public"."user_subscriptions" from "anon";

revoke insert on table "public"."user_subscriptions" from "anon";

revoke references on table "public"."user_subscriptions" from "anon";

revoke select on table "public"."user_subscriptions" from "anon";

revoke trigger on table "public"."user_subscriptions" from "anon";

revoke truncate on table "public"."user_subscriptions" from "anon";

revoke update on table "public"."user_subscriptions" from "anon";

revoke delete on table "public"."user_subscriptions" from "authenticated";

revoke insert on table "public"."user_subscriptions" from "authenticated";

revoke references on table "public"."user_subscriptions" from "authenticated";

revoke select on table "public"."user_subscriptions" from "authenticated";

revoke trigger on table "public"."user_subscriptions" from "authenticated";

revoke truncate on table "public"."user_subscriptions" from "authenticated";

revoke update on table "public"."user_subscriptions" from "authenticated";

revoke delete on table "public"."user_subscriptions" from "service_role";

revoke insert on table "public"."user_subscriptions" from "service_role";

revoke references on table "public"."user_subscriptions" from "service_role";

revoke select on table "public"."user_subscriptions" from "service_role";

revoke trigger on table "public"."user_subscriptions" from "service_role";

revoke truncate on table "public"."user_subscriptions" from "service_role";

revoke update on table "public"."user_subscriptions" from "service_role";

alter table "public"."usage_logs" drop constraint "usage_logs_action_type_check";

alter table "public"."user_subscriptions" drop constraint "user_subscriptions_status_check";

drop function if exists "public"."store_cached_response"(p_request_type text, p_params jsonb, p_response jsonb, p_cost numeric, p_confidence_score integer);

alter table "public"."usage_logs" add constraint "usage_logs_action_type_check" CHECK (((action_type)::text = ANY ((ARRAY['search'::character varying, 'export'::character varying])::text[]))) not valid;

alter table "public"."usage_logs" validate constraint "usage_logs_action_type_check";

alter table "public"."user_subscriptions" add constraint "user_subscriptions_status_check" CHECK (((status)::text = ANY ((ARRAY['active'::character varying, 'cancelled'::character varying, 'expired'::character varying])::text[]))) not valid;

alter table "public"."user_subscriptions" validate constraint "user_subscriptions_status_check";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.auto_generate_campaign_name()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
BEGIN
  -- Only generate if not already set
  IF NEW.generated_name IS NULL OR NEW.generated_name = '' THEN
    NEW.generated_name := public.generate_campaign_name(
      NEW.business_type,
      NEW.location,
      NEW.user_id
    );
  END IF;
  
  -- Set display name if not provided
  IF NEW.display_name IS NULL OR NEW.display_name = '' THEN
    NEW.display_name := NEW.business_type || ' in ' || NEW.location;
  END IF;
  
  -- Store name components
  NEW.name_components := jsonb_build_object(
    'business_type', NEW.business_type,
    'location', NEW.location,
    'generated_at', NOW(),
    'user_id', NEW.user_id
  );
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.check_usage_limit(user_uuid uuid, action_type text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  subscription_record RECORD;
  current_usage INTEGER;
  max_allowed INTEGER;
  can_proceed BOOLEAN;
BEGIN
  -- Get user subscription with tier info
  SELECT us.*, st.max_searches, st.max_exports, st.name AS tier_name
  INTO subscription_record
  FROM public.user_subscriptions us
  JOIN public.subscription_tiers st ON us.tier_id = st.id
  WHERE us.user_id = user_uuid AND us.status = 'active';

  IF NOT FOUND THEN
    RETURN json_build_object(
      'can_proceed', false,
      'usage', 0,
      'limit', 0,
      'error', 'No active subscription found'
    );
  END IF;

  -- Reset monthly usage if period has ended
  IF subscription_record.current_period_end < NOW() THEN
    UPDATE public.user_subscriptions
    SET
      current_period_start = NOW(),
      current_period_end = NOW() + INTERVAL '30 days',
      searches_used = 0,
      exports_used = 0
    WHERE user_id = user_uuid;

    -- Refresh the record
    SELECT us.*, st.max_searches, st.max_exports, st.name AS tier_name
    INTO subscription_record
    FROM public.user_subscriptions us
    JOIN public.subscription_tiers st ON us.tier_id = st.id
    WHERE us.user_id = user_uuid AND us.status = 'active';
  END IF;

  -- Check limits based on action type
  IF action_type = 'search' THEN
    current_usage := subscription_record.searches_used;
    max_allowed := subscription_record.max_searches;
  ELSIF action_type = 'export' THEN
    current_usage := subscription_record.exports_used;
    max_allowed := subscription_record.max_exports;
  ELSE
    RETURN json_build_object(
      'can_proceed', false,
      'usage', 0,
      'limit', 0,
      'error', 'Invalid action type'
    );
  END IF;

  -- Check if action is allowed (-1 means unlimited)
  can_proceed := (max_allowed = -1) OR (current_usage < max_allowed);

  RETURN json_build_object(
    'can_proceed', can_proceed,
    'usage', current_usage,
    'limit', max_allowed,
    'tier', subscription_record.tier_name,
    'period_end', subscription_record.current_period_end
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.cleanup_expired_cache()
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM public.enrichment_cache
  WHERE expires_at <= NOW() OR is_active = false;

  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.cleanup_old_deduplication_records(days_to_keep integer DEFAULT 90)
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM public.user_campaign_results
  WHERE served_at < NOW() - (days_to_keep || ' days')::INTERVAL;

  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.cleanup_old_jobs(retention_days integer DEFAULT 30)
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM discovery_jobs
  WHERE status IN ('completed', 'failed')
    AND completed_at < NOW() - (retention_days || ' days')::INTERVAL;
  
  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.create_user_profile_and_subscription()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Create user profile
  INSERT INTO public.user_profiles (id, full_name)
  VALUES (NEW.id, COALESCE(NEW.raw_user_meta_data->>'full_name', ''));

  -- Create free subscription (assuming Free tier exists with id = 1)
  INSERT INTO public.user_subscriptions (user_id, tier_id)
  VALUES (NEW.id, (
    SELECT id FROM public.subscription_tiers WHERE name = 'Free' LIMIT 1
  ));

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.current_session_identifier()
 RETURNS text
 LANGUAGE plpgsql
 STABLE
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN COALESCE(auth.jwt() ->> 'session_id', auth.uid()::text);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.filter_already_served_businesses(p_user_id uuid, p_session_user_id text, p_campaign_hash text, p_business_identifiers text[])
 RETURNS text[]
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  served_identifiers TEXT[] := ARRAY[]::TEXT[];
BEGIN
  IF p_user_id IS NOT NULL THEN
    SELECT ARRAY_AGG(business_identifier)
      INTO served_identifiers
    FROM public.user_campaign_results
    WHERE user_id = p_user_id
      AND campaign_hash = p_campaign_hash
      AND business_identifier = ANY(p_business_identifiers);
  ELSIF p_session_user_id IS NOT NULL THEN
    SELECT ARRAY_AGG(business_identifier)
      INTO served_identifiers
    FROM public.user_campaign_results
    WHERE session_user_id = p_session_user_id
      AND campaign_hash = p_campaign_hash
      AND business_identifier = ANY(p_business_identifiers);
  ELSE
    RETURN p_business_identifiers;
  END IF;

  RETURN (
    SELECT COALESCE(ARRAY_AGG(identifier), ARRAY[]::TEXT[])
    FROM unnest(p_business_identifiers) AS identifier
    WHERE identifier != ALL(COALESCE(served_identifiers, ARRAY[]::TEXT[]))
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.generate_business_identifier(business_name text, business_address text)
 RETURNS text
 LANGUAGE plpgsql
 IMMUTABLE
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN encode(digest(
    COALESCE(business_name, '') || '|' || COALESCE(business_address, ''),
    'sha256'
  ), 'base64');
END;
$function$
;

CREATE OR REPLACE FUNCTION public.generate_cache_key(p_request_type text, p_params jsonb)
 RETURNS text
 LANGUAGE plpgsql
 IMMUTABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN encode(
    digest(COALESCE(p_request_type, '') || '::' || COALESCE(p_params::TEXT, '{}'), 'sha256'),
    'hex'
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.generate_campaign_hash(business_type text, location text, min_confidence_score integer DEFAULT 50)
 RETURNS text
 LANGUAGE plpgsql
 IMMUTABLE
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN encode(digest(
    COALESCE(business_type, '') || '|' || COALESCE(location, '') || '|' || COALESCE(min_confidence_score, 50)::TEXT,
    'sha256'
  ), 'base64');
END;
$function$
;

CREATE OR REPLACE FUNCTION public.generate_campaign_name(business_type text, location text, user_id uuid DEFAULT NULL::uuid)
 RETURNS text
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
DECLARE
  business_code TEXT;
  location_code TEXT;
  date_string TEXT;
  time_string TEXT;
  user_code TEXT;
  random_component TEXT;
  campaign_name TEXT;
BEGIN
  -- Generate business type code (first 4 letters, uppercase)
  business_code := UPPER(LEFT(REGEXP_REPLACE(business_type, '[^a-zA-Z]', '', 'g'), 4));
  
  -- Generate location code (first 4 letters, uppercase)
  location_code := UPPER(LEFT(REGEXP_REPLACE(location, '[^a-zA-Z]', '', 'g'), 4));
  
  -- Generate date and time strings
  date_string := TO_CHAR(NOW(), 'YYYYMMDD');
  time_string := TO_CHAR(CLOCK_TIMESTAMP(), 'HH24MISSUS');
  
  -- Generate user code (last 6 chars of user_id or random for anonymous)
  IF user_id IS NOT NULL THEN
    user_code := RIGHT(user_id::TEXT, 6);
  ELSE
    user_code := SUBSTRING(MD5(RANDOM()::TEXT) FROM 1 FOR 6);
  END IF;

  -- Add extra entropy to avoid collisions on rapid submissions
  random_component := SUBSTRING(MD5((RANDOM()::TEXT || NOW()::TEXT)) FROM 1 FOR 6);
  
  -- Combine into final campaign name
  campaign_name := business_code || '_' || location_code || '_' || date_string || '_' || time_string || '_' || user_code || '_' || random_component;
  
  RETURN campaign_name;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_cached_response(p_request_type text, p_params jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  v_cache_key TEXT;
  v_response JSONB;
BEGIN
  v_cache_key := public.generate_cache_key(p_request_type, p_params);

  SELECT response_data INTO v_response
  FROM public.enrichment_cache
  WHERE cache_key = v_cache_key
    AND expires_at > NOW()
    AND is_active = true;

  IF v_response IS NOT NULL THEN
    UPDATE public.enrichment_cache
    SET hit_count = COALESCE(hit_count, 0) + 1,
        last_accessed_at = NOW(),
        updated_at = NOW()
    WHERE cache_key = v_cache_key;

    INSERT INTO public.enrichment_cache_stats (date, request_type, cache_hits, total_requests)
    VALUES (CURRENT_DATE, p_request_type, 1, 1)
    ON CONFLICT (date, request_type)
    DO UPDATE SET
      cache_hits = public.enrichment_cache_stats.cache_hits + 1,
      total_requests = public.enrichment_cache_stats.total_requests + 1,
      hit_ratio = ROUND(
        (public.enrichment_cache_stats.cache_hits + 1.0) /
        (public.enrichment_cache_stats.total_requests + 1.0) * 100,
        2
      ),
      updated_at = NOW();
  ELSE
    INSERT INTO public.enrichment_cache_stats (date, request_type, cache_misses, total_requests)
    VALUES (CURRENT_DATE, p_request_type, 1, 1)
    ON CONFLICT (date, request_type)
    DO UPDATE SET
      cache_misses = public.enrichment_cache_stats.cache_misses + 1,
      total_requests = public.enrichment_cache_stats.total_requests + 1,
      hit_ratio = ROUND(
        public.enrichment_cache_stats.cache_hits /
        (public.enrichment_cache_stats.total_requests + 1.0) * 100,
        2
      ),
      updated_at = NOW();
  END IF;

  RETURN v_response;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_function_summary(p_function text, p_hours integer DEFAULT 24)
 RETURNS json
 LANGUAGE sql
AS $function$
SELECT json_build_object(
    'function', p_function,
    'window_hours', p_hours,
    'total_logs', count(*),
    'error_count', count(*) FILTER (WHERE level = 'error'),
    'warn_count', count(*) FILTER (WHERE level = 'warn'),
    'avg_duration_ms', avg(duration_ms),
    'recent_errors', (
        SELECT json_agg(message)
        FROM (
            SELECT message 
            FROM public.function_logs 
            WHERE function_name = p_function 
                AND level = 'error'
                AND ts >= now() - interval '1 hour' * p_hours
            ORDER BY ts DESC 
            LIMIT 5
        ) recent
    )
)
FROM public.function_logs
WHERE function_name = p_function 
    AND ts >= now() - interval '1 hour' * p_hours;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_campaigns(target_user_id uuid DEFAULT NULL::uuid, target_session_user_id text DEFAULT NULL::text)
 RETURNS TABLE(id text, business_type text, location text, target_count integer, results_count integer, status text, total_cost numeric, created_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  effective_user_id UUID;
  effective_session_id TEXT;
BEGIN
  IF target_user_id IS NOT NULL THEN
    effective_user_id := target_user_id;
  ELSE
    effective_user_id := auth.uid();
  END IF;

  IF target_session_user_id IS NOT NULL THEN
    effective_session_id := target_session_user_id;
  ELSE
    effective_session_id := public.current_session_identifier();
  END IF;

  RETURN QUERY
  SELECT
    c.id,
    c.business_type,
    c.location,
    c.target_count,
    c.results_count,
    c.status,
    c.total_cost,
    c.created_at
  FROM public.campaigns c
  WHERE (
    effective_user_id IS NOT NULL AND c.user_id = effective_user_id
  ) OR (
    effective_user_id IS NULL AND effective_session_id IS NOT NULL AND c.session_user_id = effective_session_id
  )
  ORDER BY c.created_at DESC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_usage_stats(target_user_id uuid DEFAULT NULL::uuid, target_session_user_id text DEFAULT NULL::text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  effective_user_id UUID := target_user_id;
  effective_session_id TEXT := target_session_user_id;
  campaigns_count INTEGER := 0;
  leads_count INTEGER := 0;
  exports_count INTEGER := 0;
  total_cost DECIMAL(10,4) := 0;
  month_campaigns INTEGER := 0;
  month_cost DECIMAL(10,4) := 0;
  last_activity TIMESTAMPTZ;
  dedup_savings INTEGER := 0;
BEGIN
  IF effective_user_id IS NULL THEN
    effective_user_id := auth.uid();
  END IF;

  IF effective_session_id IS NULL THEN
    effective_session_id := public.current_session_identifier();
  END IF;

  SELECT
    COUNT(DISTINCT c.id),
    COUNT(l.id),
    COALESCE(SUM(c.total_cost), 0),
    COUNT(DISTINCT c.id) FILTER (WHERE c.created_at >= date_trunc('month', NOW())),
    COALESCE(SUM(c.total_cost) FILTER (WHERE c.created_at >= date_trunc('month', NOW())), 0),
    MAX(c.created_at)
  INTO campaigns_count, leads_count, total_cost, month_campaigns, month_cost, last_activity
  FROM public.campaigns c
  LEFT JOIN public.leads l ON l.campaign_id = c.id
  WHERE (
    effective_user_id IS NOT NULL AND c.user_id = effective_user_id
  ) OR (
    effective_user_id IS NULL AND effective_session_id IS NOT NULL AND c.session_user_id = effective_session_id
  );

  SELECT COUNT(*) INTO exports_count
  FROM public.dashboard_exports de
  WHERE (
    effective_user_id IS NOT NULL AND de.user_id = effective_user_id
  ) OR (
    effective_user_id IS NULL AND effective_session_id IS NOT NULL AND de.session_user_id = effective_session_id
  );

  SELECT COUNT(*) INTO dedup_savings
  FROM public.user_campaign_results ucr
  WHERE (
    effective_user_id IS NOT NULL AND ucr.user_id = effective_user_id
  ) OR (
    effective_user_id IS NULL AND effective_session_id IS NOT NULL AND ucr.session_user_id = effective_session_id
  );

  RETURN jsonb_build_object(
    'user_id', effective_user_id,
    'session_user_id', effective_session_id,
    'total_campaigns', campaigns_count,
    'total_leads_generated', leads_count,
    'total_exports', exports_count,
    'total_cost', total_cost,
    'current_month_campaigns', month_campaigns,
    'current_month_cost', month_cost,
    'last_activity', last_activity,
    'deduplication_saves', dedup_savings,
    'fresh_results_guaranteed', true,
    'timestamp', NOW()
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
BEGIN
  INSERT INTO public.user_profiles (id, email, full_name, avatar_url)
  VALUES (
    NEW.id,
    NEW.email,
    NEW.raw_user_meta_data->>'full_name',
    NEW.raw_user_meta_data->>'avatar_url'
  )
  ON CONFLICT (id) DO UPDATE SET
    email = EXCLUDED.email,
    full_name = EXCLUDED.full_name,
    avatar_url = EXCLUDED.avatar_url,
    updated_at = NOW();
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.increment_usage(user_uuid uuid, action_type text, campaign_id_param text DEFAULT NULL::text, cost_param numeric DEFAULT 0)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Log the usage
  INSERT INTO public.usage_logs (user_id, action_type, campaign_id, cost)
  VALUES (user_uuid, action_type, campaign_id_param, cost_param);

  -- Increment the appropriate counter
  IF action_type = 'search' THEN
    UPDATE public.user_subscriptions
    SET searches_used = searches_used + 1
    WHERE user_id = user_uuid;
  ELSIF action_type = 'export' THEN
    UPDATE public.user_subscriptions
    SET exports_used = exports_used + 1
    WHERE user_id = user_uuid;
  END IF;

  RETURN true;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.link_anonymous_campaigns_to_user(target_session_user_id text, authenticated_user_id uuid)
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  linked_total INTEGER := 0;
BEGIN
  UPDATE public.campaigns
  SET user_id = authenticated_user_id
  WHERE user_id IS NULL
    AND session_user_id = target_session_user_id;

  GET DIAGNOSTICS linked_total = ROW_COUNT;

  UPDATE public.leads
  SET user_id = authenticated_user_id
  WHERE user_id IS NULL
    AND session_user_id = target_session_user_id;

  UPDATE public.dashboard_exports
  SET user_id = authenticated_user_id
  WHERE user_id IS NULL
    AND session_user_id = target_session_user_id;

  RETURN linked_total;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.record_served_businesses(p_user_id uuid, p_session_user_id text, p_campaign_hash text, p_campaign_id text, p_businesses jsonb)
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  business_record JSONB;
  inserted_count INTEGER := 0;
BEGIN
  FOR business_record IN SELECT * FROM jsonb_array_elements(p_businesses)
  LOOP
    BEGIN
      INSERT INTO public.user_campaign_results (
        user_id,
        session_user_id,
        campaign_hash,
        business_identifier,
        campaign_id,
        business_name,
        business_address
      ) VALUES (
        p_user_id,
        p_session_user_id,
        p_campaign_hash,
        business_record ->> 'identifier',
        p_campaign_id,
        business_record ->> 'name',
        business_record ->> 'address'
      );
      inserted_count := inserted_count + 1;
    EXCEPTION WHEN unique_violation THEN
      CONTINUE;
    END;
  END LOOP;

  RETURN inserted_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.store_cached_response(p_request_type text, p_params jsonb, p_response jsonb, p_cost numeric DEFAULT 0, p_confidence_score integer DEFAULT 0)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  v_cache_key TEXT;
BEGIN
  v_cache_key := public.generate_cache_key(p_request_type, p_params);

  -- Store with 90-day expiration
  INSERT INTO public.enrichment_cache (
    cache_key,
    request_type,
    request_params,
    response_data,
    cost,
    confidence_score,
    expires_at
  ) VALUES (
    v_cache_key,
    p_request_type,
    p_params,
    p_response,
    p_cost,
    p_confidence_score,
    NOW() + INTERVAL '90 days'
  ) ON CONFLICT (cache_key)
  DO UPDATE SET
    response_data = EXCLUDED.response_data,
    cost = EXCLUDED.cost,
    confidence_score = EXCLUDED.confidence_score,
    expires_at = EXCLUDED.expires_at,
    updated_at = NOW();

  RETURN v_cache_key;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.store_cached_response(p_request_type text, p_params jsonb, p_response jsonb, p_cost numeric DEFAULT 0, p_confidence_score integer DEFAULT 0, p_ttl interval DEFAULT '90 days'::interval)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  v_cache_key TEXT;
BEGIN
  v_cache_key := public.generate_cache_key(p_request_type, p_params);

  INSERT INTO public.enrichment_cache (
    cache_key,
    request_type,
    request_params,
    response_data,
    cost,
    confidence_score,
    expires_at,
    updated_at,
    last_accessed_at,
    is_active
  ) VALUES (
    v_cache_key,
    p_request_type,
    p_params,
    p_response,
    p_cost,
    p_confidence_score,
    NOW() + p_ttl,
    NOW(),
    NOW(),
    true
  )
  ON CONFLICT (cache_key) DO UPDATE SET
    response_data = EXCLUDED.response_data,
    cost = EXCLUDED.cost,
    confidence_score = EXCLUDED.confidence_score,
    expires_at = EXCLUDED.expires_at,
    updated_at = NOW(),
    last_accessed_at = NOW(),
    is_active = true;

  INSERT INTO public.enrichment_cache_stats (date, request_type, total_cost)
  VALUES (CURRENT_DATE, p_request_type, p_cost)
  ON CONFLICT (date, request_type)
  DO UPDATE SET
    total_cost = public.enrichment_cache_stats.total_cost + p_cost,
    updated_at = NOW();

  RETURN v_cache_key;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_discovery_jobs_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
BEGIN
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_user_spending(user_id_param uuid, amount_param numeric)
 RETURNS void
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
BEGIN
  UPDATE public.user_profiles
  SET 
    total_spent = total_spent + amount_param,
    updated_at = NOW()
  WHERE id = user_id_param;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.validate_api_key_format(api_key text)
 RETURNS boolean
 LANGUAGE plpgsql
 IMMUTABLE
 SET search_path TO 'public'
AS $function$
BEGIN
  IF api_key LIKE 'sb_publishable_%' THEN
    RETURN true;
  END IF;

  IF api_key LIKE 'sb_secret_%' THEN
    RETURN true;
  END IF;

  IF api_key LIKE 'eyJ%' AND length(api_key) > 100 THEN
    RETURN true;
  END IF;

  RETURN false;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.validate_security_configuration()
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
  rls_count INTEGER;
  policy_count INTEGER;
  secure_function_count INTEGER;
  result JSONB;
BEGIN
  SELECT COUNT(*) INTO rls_count
  FROM pg_tables t
  JOIN pg_class c ON c.relname = t.tablename
  WHERE t.schemaname = 'public'
    AND c.relrowsecurity = true
    AND t.tablename IN ('campaigns', 'leads', 'dashboard_exports', 'user_campaign_results');

  SELECT COUNT(*) INTO policy_count
  FROM pg_policies
  WHERE schemaname = 'public'
    AND tablename IN ('campaigns', 'leads', 'dashboard_exports', 'user_campaign_results');

  SELECT COUNT(*) INTO secure_function_count
  FROM pg_proc p
  JOIN pg_namespace n ON n.oid = p.pronamespace
  WHERE n.nspname = 'public'
    AND p.proname IN (
      'current_session_identifier',
      'get_user_campaigns',
      'link_anonymous_campaigns_to_user',
      'generate_campaign_hash',
      'generate_business_identifier',
      'filter_already_served_businesses',
      'record_served_businesses',
      'get_user_usage_stats',
      'generate_cache_key',
      'get_cached_response',
      'store_cached_response',
      'cleanup_expired_cache'
    );

  result := jsonb_build_object(
    'timestamp', NOW(),
    'rls_enabled_tables', rls_count,
    'policy_count', policy_count,
    'secure_function_count', secure_function_count,
    'session_support', true,
    'user_campaign_linking', true,
    'cache_enabled', true,
    'deduplication_enabled', true
  );

  RETURN result;
END;
$function$
;


