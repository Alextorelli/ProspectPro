name: Generate Production Environment Configuration

# Trigger on push to main branch, server initialization, or manual dispatch
on:
  push:
    branches: [main]
  deployment:
  repository_dispatch:
    types: [generate_dotenv, server-init, prod-server-start]
  workflow_dispatch:
    inputs:
      deployment_target:
        description: "Deployment target (production/staging)"
        required: false
        default: "production"
      trigger_source:
        description: "What triggered this workflow"
        required: false
        default: "manual"

jobs:
  generate-env-and-deploy:
    name: Generate .env and Deploy
    runs-on: ubuntu-latest
    outputs:
      env-content: ${{ steps.generate-env.outputs.ENV_CONTENT }}
      build-timestamp: ${{ steps.generate-env.outputs.BUILD_TIMESTAMP }}
      build-commit: ${{ steps.generate-env.outputs.BUILD_COMMIT }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Verify Required Secrets
        run: |
          echo "ğŸ” Verifying required GitHub repository secrets..."

          # Check if required secrets are present
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "âŒ ERROR: SUPABASE_URL secret is not set"
            echo "ğŸ’¡ Add it in: Repository Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi

          if [ -z "${{ secrets.SUPABASE_SECRET_KEY }}" ]; then
            echo "âŒ ERROR: SUPABASE_SECRET_KEY secret is not set"
            echo "ğŸ’¡ Add it in: Repository Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi

          echo "âœ… All required secrets are present"
          echo "ğŸ”— SUPABASE_URL: ${SUPABASE_URL:0:30}..."
          echo "ğŸ”‘ SUPABASE_SECRET_KEY: ${SUPABASE_SECRET_KEY:0:20}..."
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SECRET_KEY }}

      - name: Generate Production .env File
        id: generate-env
        run: |
          echo "ğŸ—ï¸ Generating production .env configuration..."

          # Create .env file with production configuration
          cat > .env << EOF
          # ================================
          # PRODUCTION ENVIRONMENT CONFIGURATION
          # Generated by GitHub Actions on $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          # Commit: ${{ github.sha }}
          # Branch: ${{ github.ref_name }}
          # ================================

          # Environment Settings
          NODE_ENV=production
          PORT=3000
          ALLOW_DEGRADED_START=false

          # Supabase Database Connection (from GitHub Secrets)
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_SECRET_KEY=${{ secrets.SUPABASE_SECRET_KEY }}

          # Production Performance Settings
          DAILY_BUDGET_LIMIT=100.00
          DEFAULT_BUDGET_LIMIT=25.00
          PER_LEAD_COST_LIMIT=2.00
          COST_ALERT_THRESHOLD=80.00

          MIN_CONFIDENCE_SCORE=85
          PRE_VALIDATION_THRESHOLD=75
          EXPORT_CONFIDENCE_THRESHOLD=90

          REQUEST_TIMEOUT=30000
          REQUEST_DELAY=500
          MAX_CONCURRENT_REQUESTS=10
          BATCH_SIZE=25
          CACHE_TTL_SECONDS=3600

          GOOGLE_PLACES_RPM=1000
          HUNTER_IO_RPM=100
          NEVERBOUNCE_RPM=300
          RATE_LIMIT_WINDOW=60000

          # Production Features (All Enabled)
          ENABLE_PROMETHEUS_METRICS=true
          ENABLE_PERFORMANCE_LOGGING=true
          ENABLE_COST_TRACKING=true
          ENABLE_ERROR_REPORTING=true
          LOG_LEVEL=info

          ENABLE_TTL_CACHE=true
          ENABLE_BATCH_PROCESSING=true
          ENABLE_SMART_ROUTING=true
          ENABLE_CIRCUIT_BREAKER=true

          ENABLE_REQUEST_VALIDATION=true
          ENABLE_RATE_LIMITING=true
          REQUIRE_API_AUTHENTICATION=true

          ENABLE_DATABASE_CONNECTION_POOLING=true
          ENABLE_GRACEFUL_SHUTDOWN=true
          ENABLE_HEALTH_CHECKS=true

          # Deployment Settings
          BIND_ADDRESS=0.0.0.0
          GRACEFUL_SHUTDOWN_TIMEOUT=30000
          HEALTH_CHECK_INTERVAL=30000
          DATABASE_CONNECTION_TIMEOUT=5000
          API_CLIENT_TIMEOUT=15000
          WEBHOOK_TIMEOUT=10000

          # Build Information
          BUILD_TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S_UTC")
          BUILD_COMMIT=${{ github.sha }}
          BUILD_BRANCH=${{ github.ref_name }}
          BUILD_ACTOR=${{ github.actor }}
          EOF

          echo "âœ… Production .env file generated successfully"
          echo "ğŸ“„ File size: $(wc -c < .env) bytes"
          echo "ğŸ“‹ Configuration lines: $(wc -l < .env) lines"

          # Export .env content as workflow output for direct access
          echo "ENV_CONTENT<<ENVEOF" >> $GITHUB_OUTPUT
          cat .env >> $GITHUB_OUTPUT
          echo "ENVEOF" >> $GITHUB_OUTPUT

          # Export metadata
          echo "BUILD_TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S_UTC")" >> $GITHUB_OUTPUT
          echo "BUILD_COMMIT=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Validate Environment Configuration
        run: |
          echo "ğŸ§ª Validating generated environment configuration..."

          # Install dependencies for validation
          npm ci --only=production --silent

          # Test environment loading
          node -e "
          require('dotenv').config();
          const requiredVars = [
            'NODE_ENV', 'SUPABASE_URL', 'SUPABASE_SECRET_KEY',
            'ENABLE_PROMETHEUS_METRICS', 'ENABLE_TTL_CACHE'
          ];

          let missingVars = [];
          requiredVars.forEach(varName => {
            if (!process.env[varName]) {
              missingVars.push(varName);
            }
          });

          if (missingVars.length > 0) {
            console.log('âŒ Missing required environment variables:', missingVars);
            process.exit(1);
          }

          console.log('âœ… All required environment variables are present');
          console.log('ğŸ¯ NODE_ENV:', process.env.NODE_ENV);
          console.log('ğŸ­ Production features enabled:', {
            metrics: process.env.ENABLE_PROMETHEUS_METRICS,
            caching: process.env.ENABLE_TTL_CACHE,
            batching: process.env.ENABLE_BATCH_PROCESSING
          });
          "

      - name: Validate Server Module Dependencies
        run: |
          echo "ğŸ” Checking server.js module dependencies..."

          # Test that server.js can be parsed and required modules exist
          node -e "
          try {
            // Test core modules exist
            const fs = require('fs');
            const path = require('path');
            
            // Check critical modules exist
            const requiredModules = [
              './config/environment-loader',
              './config/supabase',
              './modules/monitoring/prometheus-metrics',
              './modules/utils/security-hardening',
              './modules/utils/boot-debugger'
            ];
            
            let missingModules = [];
            requiredModules.forEach(modulePath => {
              try {
                const resolvedPath = require.resolve(modulePath);
                if (!fs.existsSync(resolvedPath)) {
                  missingModules.push(modulePath);
                }
              } catch (e) {
                missingModules.push(modulePath + ' (resolve error: ' + e.message + ')');
              }
            });
            
            if (missingModules.length > 0) {
              console.log('âŒ Missing required modules:', missingModules);
              process.exit(1);
            }
            
            console.log('âœ… All critical server modules are available');
            
            // Test that server.js can at least be parsed
            const serverPath = path.join(__dirname, 'server.js');
            const serverCode = fs.readFileSync(serverPath, 'utf8');
            
            // Basic syntax validation
            const vm = require('vm');
            new vm.Script(serverCode);
            
            console.log('âœ… server.js syntax validation passed');
            console.log('âš ï¸  Note: Full server startup test skipped (requires API keys)');
            
          } catch (error) {
            console.log('âŒ Server validation failed:', error.message);
            process.exit(1);
          }
          "

      - name: Pre-Upload File Verification
        run: |
          echo "ğŸ” Verifying .env file before artifact upload..."
          echo "ğŸ“ Current working directory: $(pwd)"
          echo "ğŸ“‹ All files in directory:"
          ls -la
          echo ""
          echo "ğŸ¯ .env file status:"
          if [ -f .env ]; then
            echo "âœ… .env file exists"
            echo "ğŸ“ Size: $(wc -c < .env) bytes" 
            echo "ğŸ“„ Lines: $(wc -l < .env) lines"
            echo "ğŸ“ Preview (first 5 lines):"
            head -5 .env
          else
            echo "âŒ .env file NOT found"
            exit 1
          fi

      - name: Pre-Archive Debug
        run: |
          echo "ğŸ”¬ Final debug before artifact upload..."
          echo "Working directory: $(pwd)"
          echo "Files in current directory:"
          ls -la
          echo ""
          echo "ğŸ¯ .env file verification:"
          if [ -f .env ]; then
            echo "âœ… .env exists"
            echo "ğŸ“ Size: $(stat -c%s .env) bytes"
            echo "ğŸ“„ Lines: $(wc -l < .env)"
            echo "ğŸ”’ Permissions: $(stat -c%a .env)"
            echo "ğŸ‘¤ Owner: $(stat -c%U .env)"
            echo "ğŸ“‚ Absolute path: $(realpath .env)"
            echo "ğŸ” File type: $(file .env)"
            echo "ğŸ“– Content preview:"
            head -3 .env
            echo "..."
            tail -3 .env
          else
            echo "âŒ .env file does not exist!"
            exit 1
          fi

      - name: Final Upload Preparation
        run: |
          echo "ğŸš€ Preparing for artifact upload..."
          echo "ğŸ“‚ Working directory: $(pwd)"
          echo "ğŸ“‹ Full directory listing:"
          ls -la
          echo ""
          echo "ğŸ¯ Target file verification:"
          if [ -f .env ]; then
            echo "âœ… .env file confirmed present"
            echo "ğŸ“ Size: $(stat -c%s .env) bytes"
            echo "ğŸ”’ Permissions: $(stat -c%a .env)"
            echo "ğŸ“‚ Full path: $(realpath .env)"
            # Copy to ensure file is accessible
            cp .env production-env-config.env
            echo "ğŸ“‹ Backup created: production-env-config.env"
            ls -la *.env
          else
            echo "âŒ CRITICAL: .env file missing before upload!"
            exit 1
          fi

      - name: Archive Environment Configuration
        uses: actions/upload-artifact@v4
        with:
          name: production-environment-config
          path: |
            .env
            production-env-config.env
          retention-days: 30
          if-no-files-found: error
          overwrite: true

      - name: Verify Artifact Upload
        run: |
          echo "ğŸ” Verifying files before and after artifact upload..."
          echo "ğŸ“ Current working directory: $(pwd)"
          echo "ğŸ“‹ Directory contents:"
          ls -la
          echo ""
          echo "ğŸ¯ .env file details:"
          ls -la .env 2>/dev/null || echo "âŒ .env file not found"
          echo "ğŸ“ .env file size: $(wc -c < .env 2>/dev/null || echo '0') bytes"
          echo "ğŸ“„ .env file lines: $(wc -l < .env 2>/dev/null || echo '0') lines"
          echo ""
          echo "ğŸ“ .env file contents preview (first 10 lines):"
          head -10 .env 2>/dev/null || echo "âŒ Could not read .env file"

      - name: Prepare Production Environment
        if: github.ref == 'refs/heads/main' || github.event_name == 'repository_dispatch'
        run: |
          echo "ğŸš€ Production environment ready for server initialization..."
          echo "ğŸ“ Generated .env file available for production server"
          echo "ğŸ¯ Trigger source: ${{ github.event.action || 'push' }}"

          # Validate .env file is production-ready
          if grep -q "your_.*_here" .env; then
            echo "âš ï¸  Warning: Template values detected in .env - ensure secrets are properly injected"
          fi

          echo "ENV_BUILD_TIME=$(date -u +'%Y-%m-%d_%H-%M-%S_UTC')" >> environment.log
          echo "âœ… Environment configuration ready for production server initialization"

      - name: Server Initialization Signal
        if: github.ref == 'refs/heads/main' || github.event_name == 'repository_dispatch'
        run: |
          echo "ğŸ”” Signaling server initialization readiness..."
          if [ -f environment.log ]; then
            echo "Environment details:"
            cat environment.log
          fi
          echo "âœ… Production server can now be initialized with generated environment"

      - name: Deployment Summary
        run: |
          echo "## ğŸ¯ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Environment Configuration Generated Successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Generated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Config Lines**: $(wc -l < .env)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ Production Features Enabled:" >> $GITHUB_STEP_SUMMARY
          echo "- Prometheus Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- TTL Caching & Batch Processing" >> $GITHUB_STEP_SUMMARY  
          echo "- Circuit Breaker & Smart Routing" >> $GITHUB_STEP_SUMMARY
          echo "- Cost Tracking & Performance Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Ensure Supabase Vault contains all required API keys" >> $GITHUB_STEP_SUMMARY
          echo "2. Deploy to production platform with generated .env" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor deployment health via \`/health\` endpoint" >> $GITHUB_STEP_SUMMARY
