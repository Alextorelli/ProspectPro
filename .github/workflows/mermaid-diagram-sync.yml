name: Mermaid Diagram Sync
on:
  pull_request:
    paths:
      - "docs/**/*.mmd"
      - "docs/tooling/research/**"
      - "docs/tooling/staging/**"
      - "scripts/docs/render-diagrams.sh"
      - "scripts/docs/stage-taxonomy.sh"
      - ".mermaidrc.json"
      - "package.json"

jobs:
  docs-taxonomy-guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
      - name: Install dependencies
        run: npm ci
      - name: Stage taxonomy research
        run: npm run docs:stage:taxonomy
      - name: Normalize Mermaid diagrams
        run: npm run docs:patch:diagrams
      - name: Prepare documentation bundle
        run: npm run docs:prepare

  render-diagrams:
    runs-on: ubuntu-latest
    needs: docs-taxonomy-guard
    steps:
      - uses: actions/checkout@v3
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
      - name: Install dependencies
        run: npm ci
      - name: Normalize Mermaid diagrams
        run: npm run docs:patch:diagrams
      - name: Render Mermaid diagrams
        run: npm run docs:render:diagrams
      - name: Validate MCP chat modes
        run: npm run mcp:chat:validate
      - name: Commit rendered diagrams
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add public/diagrams/*.svg
          git commit -m "Auto-update rendered Mermaid diagrams" || echo "No changes to commit"
          git push || echo "No changes to push"
