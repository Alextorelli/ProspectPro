%%{init: { "theme": "dark", "fontFamily": "Inter", "flowchart": { "htmlLabels": false, "curve": "monotoneX" } }}%%
flowchart TB
    subgraph ENV["🛠️ Development Environment"]
        direction TB
        ENV_LABEL["Unrestricted · Rapid Iteration · Full MCP Access"]
    end

    subgraph ORCH["🧠 Agent Orchestration"]
        direction TB
        AO["🤖 Agent Orchestrator"]
        CM["🗂️ Context Manager"]
        EM["🌍 Environment Manager"]
    end

    subgraph AGENTS["👥 Active Agents"]
        direction LR
        DEV["💻 Dev Workflow<br/><i>Primary Agent</i>"]
        ARCH["🏗️ System Architect<br/><i>Design & Research</i>"]
    end

    subgraph MEMORY["🧠 Memory & Context Store"]
        direction TB
        subgraph STORES["📦 Session Stores"]
            direction LR
            SCRATCH["📝 Scratchpad<br/><i>80 entries max</i>"]
            LTM["🗄️ Long-term Memory<br/><i>Unlimited</i>"]
            CHKPT["📸 Checkpoints<br/><i>Auto-save enabled</i>"]
        end
        subgraph SCHEMAS["📐 Active Schemas"]
            direction LR
            AGENT_CTX["📄 Agent Context"]
            ENV_CTX["🌍 Environment Context"]
            TASK_LED["📋 Task Ledger"]
        end
    end

    subgraph MCP["🌐 MCP Mesh - Full Access"]
        direction LR
        UT["🧰 Utility MCP"]
        SUP["🗄️ Supabase MCP"]
        GH["📁 GitHub MCP"]
        PW["🧪 Playwright MCP"]
        C7["🛰️ Context7 MCP"]
    end

    subgraph SIGNALS["📡 Development Signals"]
        direction TB
        BUILD["🔨 Build Signals"]
        TEST["✅ Test Results"]
        DESIGN["📐 Design Decisions"]
    end

    %% Orchestration Flow
    ENV_LABEL -.-> EM
    CM -- "Stage Dev Context" --> AO
    AO -- "Route to Dev/Arch" --> AGENTS
    
    %% Agent-specific workflows
    AO -- "Launch Build Cycle" --> DEV
    AO -- "Design System" --> ARCH

    %% Agent → MCP interactions (unrestricted)
    DEV -- "Code · Test · Data · Deploy Local" --> MCP
    ARCH -- "Research · Design · Prototype" --> MCP

    %% MCP → Signals feedback
    MCP -- "Build Status" --> BUILD
    MCP -- "Test Coverage" --> TEST
    MCP -- "Design Artifacts" --> DESIGN

    %% Signals → Orchestration loop
    BUILD -.-> AO
    TEST -.-> DEV
    DESIGN -.-> ARCH

    %% Context Management (bidirectional, high frequency)
    CM <--> MEMORY
    AGENTS <===> MEMORY
    EM <--> MEMORY

    %% MCP Utility provides core services
    UT -- "Memory · Sequential · Time" --> MEMORY
    MEMORY -- "Frequent Checkpoints" --> UT

    %% Container-level relationships
    ORCH <--> AGENTS
    AGENTS <==> MCP
    MCP <.-> SIGNALS
    SIGNALS <.-> ORCH

    style DEV fill:#2d5016,stroke:#4ade80,stroke-width:3px
    style ARCH fill:#1e3a5f,stroke:#60a5fa,stroke-width:3px
    style ENV_LABEL fill:#065f46,stroke:#10b981,stroke-width:2px
