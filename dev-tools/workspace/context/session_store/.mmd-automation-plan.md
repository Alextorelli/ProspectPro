# Mermaid Diagram Automation Plan (2025-10-26)

## Overview

This document defines the curated set of scripts and workflow for diagram automation in ProspectPro. It clarifies which tools are core, their intended usage, and the recommended flow for CI, pre-commit, and onboarding.

---

## Core Tools & Roles

### 1. `update-indexes.mjs`

- **Purpose:** Regenerates the diagram index and `live-tooling-list.txt` from all `.mmd` files and inventories.
- **When to use:** Always in CI and as part of full automation. Not required for every local edit.

### 2. `validate-mermaid-diagrams.sh`

- **Purpose:** Runs `npm run docs:prepare` and lints all diagram folders for syntax and standards compliance.
- **When to use:** Always in CI and pre-commit. Can be run locally for validation.

### 3. `check-tags.mjs`

- **Purpose:** Checks all `.mmd` files for required tags (domain, compliance, reciprocal, type, title, index).
- **When to use:** Always in CI and pre-commit. Can be run locally for coverage checks.

### 4. `run-mermaid-automation.sh`

- **Purpose:** Orchestrates index update, diagram generation, validation, and (optionally) auto-staging/committing.
- **When to use:**
  - **CI:** Run in full mode (stages/commits changes if needed).
  - **Pre-commit/local:** Run in `--validate` mode (no file mutation or commit).

---

## Optional/Onboarding Tools

### 5. `scaffold-diagrams.sh`

- **Purpose:** Scaffolds missing diagrams per the MECE index, injecting taxonomy and compliance anchors.
- **When to use:** Onboarding, taxonomy expansion, or when adding new diagram families. Not required in every CI run.

### 6. `generate-diagrams.mjs`

- **Purpose:** Tracks and hashes `.mmd` files for change detection. Does not render SVG (VS Code handles preview).
- **When to use:** Optional for local change tracking. Not required for core validation or CI.

---

## Recommended CI/Pre-commit Flow

1. **Pre-commit (Husky):**

   - Run `run-mermaid-automation.sh --validate` (validation only, no mutation or commit).
   - Run `validate-mermaid-diagrams.sh` and `check-tags.mjs` as part of validation.

2. **CI:**
   - Run `run-mermaid-automation.sh` in full mode (may update index, generate diagrams, and auto-commit if changes are detected).
   - Run `validate-mermaid-diagrams.sh` and `check-tags.mjs` for standards and tag coverage.

---

## Migration & Deprecation Notes

- **Deprecated:** Any legacy hooks or scripts that auto-stage/commit during local development should be removed.
- **Legacy:** `.git/hooks/pre-commit` (non-Husky) should not be present; only `.husky/pre-commit` is supported.
- **SVG Rendering:** Handled by VS Code preview; no CLI SVG generation required.

---

## Summary Table

| Script                       | Core/Optional | CI  |      Pre-commit      | Local/Onboarding |
| ---------------------------- | :-----------: | :-: | :------------------: | :--------------: |
| update-indexes.mjs           |     Core      |  ✔  | ✔ (via orchestrator) |    ✔ (manual)    |
| validate-mermaid-diagrams.sh |     Core      |  ✔  |          ✔           |        ✔         |
| check-tags.mjs               |     Core      |  ✔  |          ✔           |        ✔         |
| run-mermaid-automation.sh    |     Core      |  ✔  |     ✔ (validate)     |    ✔ (manual)    |
| scaffold-diagrams.sh         |   Optional    |     |                      |        ✔         |
| generate-diagrams.mjs        |   Optional    |     |                      |  ✔ (if desired)  |

---

## Maintenance

- Update this plan as new diagram automation needs arise.
- Ensure all contributors use the Husky-managed pre-commit hook for local validation.
- Remove or archive deprecated scripts to avoid confusion.
