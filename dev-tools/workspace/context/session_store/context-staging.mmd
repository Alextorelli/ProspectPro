%%{init: { "theme": "dark", "fontFamily": "Inter", "flowchart": { "htmlLabels": false, "curve": "monotoneX" } }}%%
flowchart TB
    subgraph ENV["ğŸ“Š Staging/Observability Environment"]
        direction TB
        ENV_LABEL["Monitoring Â· Diagnostics Â· Read-Mostly Access"]
    end

    subgraph ORCH["ğŸ§  Agent Orchestration"]
        direction TB
        AO["ğŸ¤– Agent Orchestrator"]
        CM["ğŸ—‚ï¸ Context Manager"]
        EM["ğŸŒ Environment Manager"]
    end

    subgraph AGENTS["ğŸ‘¥ Active Agents"]
        direction LR
        OBS["ğŸ“ˆ Observability<br/><i>Primary Agent</i>"]
        DEV["ğŸ’» Dev Workflow<br/><i>Support Role</i>"]
    end

    subgraph MEMORY["ğŸ§  Memory & Context Store"]
        direction TB
        subgraph STORES["ğŸ“¦ Session Stores"]
            direction LR
            SCRATCH["ğŸ“ Scratchpad<br/><i>60 entries max</i>"]
            LTM["ğŸ—„ï¸ Long-term Memory<br/><i>Metrics & Baselines</i>"]
            CHKPT["ğŸ“¸ Checkpoints<br/><i>Hourly snapshots</i>"]
        end
        subgraph SCHEMAS["ğŸ“ Active Schemas"]
            direction LR
            AGENT_CTX["ğŸ“„ Agent Context"]
            ENV_CTX["ğŸŒ Environment Context"]
            TASK_LED["ğŸ“‹ Task Ledger"]
        end
    end

    subgraph MCP["ğŸŒ MCP Mesh - Read Focus"]
        direction LR
        UT["ğŸ§° Utility MCP"]
        SUP["ğŸ—„ï¸ Supabase MCP<br/><i>Read-only</i>"]
    end

    subgraph SIGNALS["ğŸ“¡ Observability Signals"]
        direction TB
        METRICS["ğŸ“Š Performance Metrics"]
        LOGS["ğŸ“œ System Logs"]
        ALERTS["ğŸš¨ Alert Triggers"]
    end

    %% Orchestration Flow
    ENV_LABEL -.-> EM
    CM -- "Stage Observability Context" --> AO
    AO -- "Route to Observability" --> AGENTS
    
    %% Agent-specific workflows
    AO -- "Monitor Stack" --> OBS
    AO -- "Support Diagnostics" --> DEV

    %% Agent â†’ MCP interactions (read-heavy)
    OBS -- "Query Metrics Â· Analyze Logs" --> MCP
    DEV -- "Limited Write Â· Diagnostics" --> MCP

    %% MCP â†’ Signals feedback
    MCP -- "Stream Metrics" --> METRICS
    MCP -- "Capture Logs" --> LOGS
    MCP -- "Detect Anomalies" --> ALERTS

    %% Signals â†’ Orchestration loop
    METRICS -.-> OBS
    LOGS -.-> OBS
    ALERTS -.-> AO

    %% Context Management (read-heavy, selective writes)
    CM <--> MEMORY
    AGENTS <-.-> MEMORY
    EM <--> MEMORY

    %% MCP Utility provides core services
    UT -- "Memory Â· Sequential Â· Time" --> MEMORY
    MEMORY -- "Periodic Checkpoints" --> UT

    %% Container-level relationships
    ORCH <--> AGENTS
    AGENTS <.-> MCP
    MCP <==> SIGNALS
    SIGNALS <.-> ORCH

    style OBS fill:#4c1d95,stroke:#a78bfa,stroke-width:3px
    style DEV fill:#1e3a5f,stroke:#60a5fa,stroke-width:2px,stroke-dasharray: 5 5
    style ENV_LABEL fill:#4338ca,stroke:#818cf8,stroke-width:2px
