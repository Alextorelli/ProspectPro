%%{init: { "theme": "dark", "fontFamily": "Inter", "flowchart": { "htmlLabels": false, "curve": "monotoneX" } }}%%
flowchart TB
    subgraph ENV["ğŸš€ Production Environment"]
        ENV_LABEL["Read-Only Â· Approval Required Â· Restricted MCP Access"]
    end
    
    subgraph ORCH["ğŸ§  Orchestration Layer"]
        direction LR
        CM["ğŸ—‚ï¸ Context Manager"]
        AO["ğŸ¤– Agent Orchestrator"]
        EM["ğŸŒ Environment Manager<br/><i>Approval Gate Active</i>"]
    end

    ENV --> EM
    EM --> ORCH
    CM --> AO

    subgraph APPROVAL["âœ‹ Approval Layer"]
        HUMAN["ğŸ‘¤ Human Approval Required"]
    end

    AO --> APPROVAL

    subgraph AGENTS["ğŸ‘¥ Agent Workflows"]
        direction LR
        
        subgraph OPS_FLOW["ğŸš€ Production Ops Agent"]
            direction TB
            OPS_START["ğŸš€ Start"]
            OPS_MEM["ğŸ§  Load Context<br/>40 entries Â· Audit"]
            OPS_MCP["ğŸŒ MCP Mesh<br/>Ship & Observe"]
            OPS_SIG["ğŸ¯ Deploy Status<br/>ğŸ“Š Telemetry"]
            OPS_SAVE["ğŸ’¾ Checkpoint<br/>Pre/Post Deploy"]
            OPS_END["âœ… Complete"]
            
            OPS_START --> OPS_MEM
            OPS_MEM --> OPS_MCP
            OPS_MCP --> OPS_SIG
            OPS_SIG --> OPS_SAVE
            OPS_SAVE --> OPS_END
            OPS_END -.-> OPS_START
        end

        subgraph OBS_FLOW["ğŸ“ˆ Observability Agent (Support)"]
            direction TB
            OBS_START["ğŸš€ Start"]
            OBS_MEM["ğŸ§  Load Context<br/>Read-Only"]
            OBS_MCP["ğŸŒ MCP Mesh<br/>Read Telemetry"]
            OBS_SIG["ğŸš¨ Incident Alerts<br/>ğŸ“Š Metrics"]
            OBS_SAVE["ğŸ’¾ Checkpoint<br/>Incident Only"]
            OBS_END["âœ… Complete"]
            
            OBS_START --> OBS_MEM
            OBS_MEM --> OBS_MCP
            OBS_MCP --> OBS_SIG
            OBS_SIG --> OBS_SAVE
            OBS_SAVE --> OBS_END
            OBS_END -.-> OBS_START
        end
    end

    APPROVAL -- "Approved" --> OPS_START
    APPROVAL -- "Rejected" -.-> AO
    AO -- "Monitor Production" --> OBS_START
    OBS_SIG -- "Critical Incident" ==> APPROVAL

    subgraph SHARED["ğŸ”„ Shared Infrastructure"]
        direction LR
        MEMORY["ğŸ§  Memory Store<br/>Deploy History Â· Configs Â· Audit"]
        MCP["ğŸŒ Restricted MCP<br/>Supabase (Deploy) Â· GitHub (PR)<br/>Utility (RO)"]
    end

    AGENTS <==> SHARED
    ORCH <--> SHARED
    APPROVAL -.-> EM

    style ENV fill:#991b1b,stroke:#ef4444,stroke-width:2px
    style ORCH fill:#1a1a1a,stroke:#ef4444,stroke-width:2px
    style APPROVAL fill:#854d0e,stroke:#fbbf24,stroke-width:3px
    style OPS_FLOW fill:#3a1a1a,stroke:#f87171,stroke-width:2px
    style OBS_FLOW fill:#2a1a3a,stroke:#a78bfa,stroke-width:2px,stroke-dasharray: 5 5
    style SHARED fill:#1a1a1a,stroke:#ef4444,stroke-width:2px
    style OPS_START fill:#7f1d1d,stroke:#f87171,stroke-width:3px
    style OBS_START fill:#4c1d95,stroke:#a78bfa,stroke-width:2px,stroke-dasharray: 5 5
    style OPS_END fill:#7f1d1d,stroke:#f87171,stroke-width:3px
    style OBS_END fill:#4c1d95,stroke:#a78bfa,stroke-width:2px,stroke-dasharray: 5 5
    style HUMAN fill:#854d0e,stroke:#fbbf24,stroke-width:2px
