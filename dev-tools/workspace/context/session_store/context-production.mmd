%%{init: { "theme": "dark", "fontFamily": "Inter", "flowchart": { "htmlLabels": false, "curve": "monotoneX" } }}%%
flowchart TB
    subgraph ENV["ğŸš€ Production Environment"]
        direction TB
        ENV_LABEL["Read-Only Â· Approval Required Â· Restricted MCP Access"]
    end

    subgraph ORCH["ğŸ§  Agent Orchestration"]
        direction TB
        AO["ğŸ¤– Agent Orchestrator"]
        CM["ğŸ—‚ï¸ Context Manager"]
        EM["ğŸŒ Environment Manager<br/><i>Approval Gate Active</i>"]
    end

    subgraph AGENTS["ğŸ‘¥ Active Agents"]
        direction LR
        OPS["ğŸš€ Production Ops<br/><i>Primary Agent</i>"]
        OBS["ğŸ“ˆ Observability<br/><i>Support Role</i>"]
    end

    subgraph MEMORY["ğŸ§  Memory & Context Store"]
        direction TB
        subgraph STORES["ğŸ“¦ Session Stores"]
            direction LR
            SCRATCH["ğŸ“ Scratchpad<br/><i>40 entries max</i>"]
            LTM["ğŸ—„ï¸ Long-term Memory<br/><i>Deploy History Â· Configs</i>"]
            CHKPT["ğŸ“¸ Checkpoints<br/><i>Pre/Post Deploy</i>"]
        end
        subgraph SCHEMAS["ğŸ“ Active Schemas"]
            direction LR
            AGENT_CTX["ğŸ“„ Agent Context"]
            ENV_CTX["ğŸŒ Environment Context"]
            TASK_LED["ğŸ“‹ Task Ledger<br/><i>Audit Trail</i>"]
        end
    end

    subgraph MCP["ğŸŒ MCP Mesh - Restricted"]
        direction LR
        UT["ğŸ§° Utility MCP<br/><i>Read-only</i>"]
        SUP["ğŸ—„ï¸ Supabase MCP<br/><i>Deploy only</i>"]
        GH["ğŸ“ GitHub MCP<br/><i>PR/Release only</i>"]
    end

    subgraph SIGNALS["ğŸ“¡ Production Signals"]
        direction TB
        DEPLOY["ğŸ¯ Deploy Status"]
        TELEM["ğŸ“Š Release Telemetry"]
        INCIDENT["ğŸš¨ Incident Alerts"]
    end

    subgraph APPROVAL["âœ‹ Approval Layer"]
        direction TB
        HUMAN["ğŸ‘¤ Human Approval Required"]
    end

    %% Orchestration Flow
    ENV_LABEL -.-> EM
    CM -- "Stage Production Context" --> AO
    AO -- "Route to Ops" --> AGENTS
    
    %% Agent-specific workflows with approval
    AO -- "Request Deploy" --> APPROVAL
    APPROVAL -- "Approved" --> OPS
    AO -- "Monitor Production" --> OBS

    %% Agent â†’ MCP interactions (restricted)
    OPS -- "Ship & Observe<br/><i>Approved Actions Only</i>" --> MCP
    OBS -- "Read Telemetry Â· Monitor" --> MCP

    %% MCP â†’ Signals feedback
    MCP -- "Deploy Outcome" --> DEPLOY
    MCP -- "Stream Telemetry" --> TELEM
    MCP -- "Critical Alerts" --> INCIDENT

    %% Signals â†’ Orchestration loop
    DEPLOY -.-> AO
    TELEM -.-> CM
    INCIDENT ==> OPS

    %% Context Management (read-only, audit trail)
    CM <--> MEMORY
    AGENTS <-.-> MEMORY
    EM <--> MEMORY

    %% MCP Utility provides core services (restricted)
    UT -- "Memory Â· Sequential Â· Time" --> MEMORY
    MEMORY -- "Mandatory Checkpoints" --> UT

    %% Container-level relationships
    ORCH <--> AGENTS
    AGENTS <.-> MCP
    MCP <==> SIGNALS
    SIGNALS <.-> ORCH
    APPROVAL -.-> EM

    style OPS fill:#7f1d1d,stroke:#f87171,stroke-width:3px
    style OBS fill:#4c1d95,stroke:#a78bfa,stroke-width:2px,stroke-dasharray: 5 5
    style ENV_LABEL fill:#991b1b,stroke:#ef4444,stroke-width:2px
    style APPROVAL fill:#854d0e,stroke:#fbbf24,stroke-width:3px
    style HUMAN fill:#854d0e,stroke:#fbbf24,stroke-width:2px
