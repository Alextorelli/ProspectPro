<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ProspectPro v4.2 - User-Aware Business Discovery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      .loading {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Header with User Authentication -->
    <header class="bg-white shadow-sm border-b">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">ProspectPro v4.2</h1>
            <p class="text-sm text-gray-600">
              User-Aware Business Discovery Platform
            </p>
          </div>
          <div id="authSection" class="flex items-center space-x-4">
            <!-- Authentication UI will be injected here -->
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Discovery Form -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">
              Business Discovery
            </h2>

            <form id="discoveryForm" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label
                    for="businessType"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Business Type
                  </label>
                  <input
                    type="text"
                    id="businessType"
                    name="businessType"
                    placeholder="e.g., coffee shop, restaurant, salon"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>

                <div>
                  <label
                    for="location"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Location
                  </label>
                  <input
                    type="text"
                    id="location"
                    name="location"
                    placeholder="e.g., Seattle, WA"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label
                    for="maxResults"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Target Leads
                  </label>
                  <select
                    id="maxResults"
                    name="maxResults"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="5">5 leads</option>
                    <option value="10" selected>10 leads</option>
                    <option value="15">15 leads</option>
                    <option value="25">25 leads</option>
                  </select>
                </div>

                <div>
                  <label
                    for="budgetLimit"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Budget Limit
                  </label>
                  <select
                    id="budgetLimit"
                    name="budgetLimit"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="25">$25</option>
                    <option value="50" selected>$50</option>
                    <option value="100">$100</option>
                    <option value="200">$200</option>
                  </select>
                </div>

                <div>
                  <label
                    for="minConfidenceScore"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Min Confidence
                  </label>
                  <select
                    id="minConfidenceScore"
                    name="minConfidenceScore"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="30">30%</option>
                    <option value="50" selected>50%</option>
                    <option value="70">70%</option>
                    <option value="85">85%</option>
                  </select>
                </div>
              </div>

              <button
                type="submit"
                id="submitBtn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md transition duration-200 flex items-center justify-center"
              >
                <span id="submitText">Start Discovery</span>
                <div id="submitSpinner" class="loading ml-2 hidden">
                  <div
                    class="w-4 h-4 border-2 border-white border-t-transparent rounded-full"
                  ></div>
                </div>
              </button>
            </form>
          </div>
        </div>

        <!-- User Dashboard -->
        <div class="space-y-6">
          <!-- User Status -->
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
              User Status
            </h3>
            <div id="userStatus" class="space-y-2 text-sm">
              <!-- Status will be injected here -->
            </div>
          </div>

          <!-- Recent Campaigns -->
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
              Recent Campaigns
            </h3>
            <div id="recentCampaigns" class="space-y-3">
              <!-- Campaigns will be injected here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div id="resultsSection" class="mt-8 hidden">
        <div class="bg-white rounded-lg shadow">
          <div
            class="px-6 py-4 border-b border-gray-200 flex justify-between items-center"
          >
            <h3 class="text-lg font-semibold text-gray-900">
              Discovery Results
            </h3>
            <button
              id="exportBtn"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm transition duration-200"
            >
              Export CSV
            </button>
          </div>
          <div id="resultsContent" class="p-6">
            <!-- Results will be injected here -->
          </div>
        </div>
      </div>
    </div>

    <script>
      // ProspectPro v4.2 - User-Aware Frontend
      // October 4, 2025 - Complete authentication integration

      // Initialize Supabase with new API keys
      const SUPABASE_URL = "https://sriycekxdqnesdsgwiuc.supabase.co";
      const SUPABASE_ANON_KEY =
        "sb_publishable_GaGU6ZiyiO6ncO7kU2qAvA_SFuCyYaM";
      const EDGE_FUNCTION_JWT =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyaXljZWt4ZHFuZXNkc2d3aXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NjU3ODksImV4cCI6MjA3MzU0MTc4OX0.Rx_1Hjz2eayKie0RpPB28i7_683ZwhVJ_5Eu_rzTWpI";

      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // Global state
      let currentUser = null;
      let sessionUserId = null;
      let lastCampaignId = null;

      // Generate session ID for anonymous users
      function generateSessionId() {
        return (
          "session_" +
          Date.now() +
          "_" +
          Math.random().toString(36).substr(2, 9)
        );
      }

      // Initialize session
      function initializeSession() {
        if (!sessionUserId) {
          sessionUserId = generateSessionId();
          console.log("Generated session ID:", sessionUserId);
        }
      }

      // Authentication handlers
      async function initializeAuth() {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        currentUser = session?.user || null;

        updateAuthUI();
        updateUserStatus();
        loadRecentCampaigns();
      }

      function updateAuthUI() {
        const authSection = document.getElementById("authSection");

        if (currentUser) {
          authSection.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-700">
                            ${currentUser.email}
                        </span>
                        <button onclick="signOut()" class="text-sm text-red-600 hover:text-red-800">
                            Sign Out
                        </button>
                    </div>
                `;
        } else {
          authSection.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <button onclick="signIn()" class="text-sm text-blue-600 hover:text-blue-800">
                            Sign In
                        </button>
                        <button onclick="signUp()" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
                            Sign Up
                        </button>
                    </div>
                `;
        }
      }

      function updateUserStatus() {
        const userStatus = document.getElementById("userStatus");

        if (currentUser) {
          userStatus.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-green-700">Authenticated User</span>
                    </div>
                    <div class="text-gray-600">Email: ${currentUser.email}</div>
                    <div class="text-gray-600">Campaigns linked to your account</div>
                `;
        } else {
          userStatus.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                        <span class="text-yellow-700">Anonymous Session</span>
                    </div>
                    <div class="text-gray-600">Session ID: ${
                      sessionUserId || "Not initialized"
                    }</div>
                    <div class="text-gray-600">Sign up to save campaigns permanently</div>
                `;
        }
      }

      async function signIn() {
        const email = prompt("Enter your email:");
        if (!email) return;

        const password = prompt("Enter your password:");
        if (!password) return;

        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password,
        });

        if (error) {
          alert("Sign in failed: " + error.message);
        } else {
          currentUser = data.user;
          updateAuthUI();
          updateUserStatus();
          loadRecentCampaigns();
        }
      }

      async function signUp() {
        const email = prompt("Enter your email:");
        if (!email) return;

        const password = prompt("Create a password (min 6 characters):");
        if (!password || password.length < 6) {
          alert("Password must be at least 6 characters");
          return;
        }

        const { data, error } = await supabase.auth.signUp({
          email: email,
          password: password,
        });

        if (error) {
          alert("Sign up failed: " + error.message);
        } else {
          alert("Check your email for confirmation link!");
        }
      }

      async function signOut() {
        await supabase.auth.signOut();
        currentUser = null;
        updateAuthUI();
        updateUserStatus();
        loadRecentCampaigns();
      }

      // Load recent campaigns
      async function loadRecentCampaigns() {
        try {
          let query = supabase
            .from("campaigns")
            .select("*")
            .order("created_at", { ascending: false })
            .limit(5);

          const { data: campaigns, error } = await query;

          const recentCampaigns = document.getElementById("recentCampaigns");

          if (error || !campaigns || campaigns.length === 0) {
            recentCampaigns.innerHTML =
              '<p class="text-gray-500 text-sm">No campaigns yet</p>';
            return;
          }

          recentCampaigns.innerHTML = campaigns
            .map(
              (campaign) => `
                    <div class="border border-gray-200 rounded p-3 hover:bg-gray-50 cursor-pointer" onclick="viewCampaign('${campaign.id}')">
                        <div class="font-medium text-sm">${campaign.business_type}</div>
                        <div class="text-xs text-gray-600">${campaign.location}</div>
                        <div class="text-xs text-gray-500 mt-1">${campaign.results_count} leads • $${campaign.total_cost}</div>
                    </div>
                `
            )
            .join("");
        } catch (error) {
          console.error("Error loading campaigns:", error);
        }
      }

      // Discovery form handler
      document
        .getElementById("discoveryForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const submitBtn = document.getElementById("submitBtn");
          const submitText = document.getElementById("submitText");
          const submitSpinner = document.getElementById("submitSpinner");

          // Show loading state
          submitBtn.disabled = true;
          submitText.textContent = "Discovering...";
          submitSpinner.classList.remove("hidden");

          try {
            const formData = new FormData(e.target);
            const requestData = {
              businessType: formData.get("businessType"),
              location: formData.get("location"),
              maxResults: parseInt(formData.get("maxResults")),
              budgetLimit: parseFloat(formData.get("budgetLimit")),
              minConfidenceScore: parseInt(formData.get("minConfidenceScore")),
              userEmail: currentUser?.email,
              sessionUserId: sessionUserId,
            };

            console.log("Starting discovery with:", requestData);

            const response = await fetch(
              `${SUPABASE_URL}/functions/v1/business-discovery-user-aware`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${EDGE_FUNCTION_JWT}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(requestData),
              }
            );

            const result = await response.json();

            if (result.success) {
              lastCampaignId = result.campaignId;
              displayResults(result);
              loadRecentCampaigns(); // Refresh campaigns list
            } else {
              throw new Error(result.error || "Discovery failed");
            }
          } catch (error) {
            console.error("Discovery error:", error);
            alert("Discovery failed: " + error.message);
          } finally {
            // Reset loading state
            submitBtn.disabled = false;
            submitText.textContent = "Start Discovery";
            submitSpinner.classList.add("hidden");
          }
        });

      // Display results
      function displayResults(result) {
        const resultsSection = document.getElementById("resultsSection");
        const resultsContent = document.getElementById("resultsContent");

        resultsContent.innerHTML = `
                <div class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-blue-50 p-4 rounded">
                            <div class="text-2xl font-bold text-blue-700">${
                              result.results.totalFound
                            }</div>
                            <div class="text-sm text-blue-600">Leads Found</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded">
                            <div class="text-2xl font-bold text-green-700">${
                              result.results.averageConfidence
                            }%</div>
                            <div class="text-sm text-green-600">Avg Confidence</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded">
                            <div class="text-2xl font-bold text-purple-700">$${result.optimization.totalCost.toFixed(
                              2
                            )}</div>
                            <div class="text-sm text-purple-600">Total Cost</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded">
                            <div class="text-2xl font-bold text-gray-700">${
                              result.optimization.processingTime
                            }</div>
                            <div class="text-sm text-gray-600">Processing Time</div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                        <div class="text-sm">
                            <strong>User Context:</strong> 
                            ${
                              result.userManagement.isAuthenticated
                                ? "Authenticated User"
                                : "Anonymous Session"
                            } • 
                            Campaign Ownership: ${
                              result.userManagement.campaignOwnership
                            }
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Business</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${result.leads
                              .map(
                                (lead) => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="font-medium text-gray-900">${
                                          lead.businessName
                                        }</div>
                                        <div class="text-sm text-gray-500">${
                                          lead.address
                                        }</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <div>📞 ${lead.phone}</div>
                                        <div>🌐 <a href="${
                                          lead.website
                                        }" target="_blank" class="text-blue-600 hover:underline">${
                                  lead.website
                                }</a></div>
                                        <div>✉️ ${lead.email}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                          lead.optimizedScore >= 80
                                            ? "bg-green-100 text-green-800"
                                            : lead.optimizedScore >= 60
                                            ? "bg-yellow-100 text-yellow-800"
                                            : "bg-red-100 text-red-800"
                                        }">${lead.optimizedScore}%</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        $${lead.validationCost.toFixed(3)}
                                    </td>
                                </tr>
                            `
                              )
                              .join("")}
                        </tbody>
                    </table>
                </div>
            `;

        resultsSection.classList.remove("hidden");
        resultsSection.scrollIntoView({ behavior: "smooth" });
      }

      // Export functionality
      document
        .getElementById("exportBtn")
        .addEventListener("click", async () => {
          if (!lastCampaignId) {
            alert("No campaign to export");
            return;
          }

          try {
            const requestData = {
              campaignId: lastCampaignId,
              format: "csv",
              includeEnrichmentData: true,
              userEmail: currentUser?.email,
              sessionUserId: sessionUserId,
            };

            const response = await fetch(
              `${SUPABASE_URL}/functions/v1/campaign-export-user-aware?download=true`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${EDGE_FUNCTION_JWT}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(requestData),
              }
            );

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = `prospectpro_export_${lastCampaignId.slice(-8)}.csv`;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            } else {
              throw new Error("Export failed");
            }
          } catch (error) {
            console.error("Export error:", error);
            alert("Export failed: " + error.message);
          }
        });

      // View campaign details
      async function viewCampaign(campaignId) {
        lastCampaignId = campaignId;
        // You could load and display campaign details here
        alert(
          `Campaign ${campaignId} selected. Export functionality available.`
        );
      }

      // Initialize the application
      document.addEventListener("DOMContentLoaded", () => {
        initializeSession();
        initializeAuth();
      });

      // Listen for auth changes
      supabase.auth.onAuthStateChange((event, session) => {
        currentUser = session?.user || null;
        updateAuthUI();
        updateUserStatus();

        if (event === "SIGNED_IN") {
          loadRecentCampaigns();
        }
      });
    </script>
  </body>
</html>
