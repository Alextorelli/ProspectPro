%% Context Orchestration Pipeline
%% accTitle: Context Orchestration Pipeline
%% accDescr: Top-down context flow from intake through normalization, storage, routing, execution, and reporting
%% Palette: context #64748b, agent #f97316, workflow #16a34a, mcp #2563eb, report #facc15
flowchart TD
	subgraph IntakeLayer["Intake"]
		direction LR
		Intake["Receive Input"]:::agent
	end

	subgraph NormalizeLayer["Normalize & Store"]
		direction LR
		Normalize["Normalize Context"]:::context
		Write["Write Snapshot"]:::context
		Compress["Compress Snapshot"]:::context
	end

	subgraph RetrieveLayer["Retrieve & Route"]
		direction LR
		Retrieve["Select Context"]:::context
		Route["Route Agent"]:::workflow
	end

	subgraph ExecuteLayer["Execute"]
		direction LR
		SmartDebug["Smart Debug"]:::agent
		FeatureDelivery["Feature Delivery"]:::agent
		ExecMCP["Invoke MCP"]:::mcp
	end

	subgraph ReportLayer["Report & Adjust"]
		direction LR
		Ledger["Update Ledger"]:::report
		Env["Mode Switch"]:::config
	end

	Intake --> Normalize
	Normalize --> Write
	Write --> Compress
	Compress --> Retrieve
	Retrieve --> Route
	Route --> SmartDebug
	Route --> FeatureDelivery
	SmartDebug --> ExecMCP
	FeatureDelivery --> ExecMCP
	ExecMCP --> Ledger
	Ledger -.->|"iterative compression"| Normalize
	Env -.->|"mode switch"| Intake
	Env -.->|"mode switch"| ExecMCP

	Write -- "checkpoint()" --> Retrieve
	Compress -- "compress()" --> Retrieve

	classDef context fill:#64748b,color:#fff;
	classDef agent fill:#f97316,color:#fff;
	classDef workflow fill:#16a34a,color:#fff;
	classDef mcp fill:#2563eb,color:#fff;
	classDef report fill:#facc15,color:#222;
	classDef config fill:#2563eb,color:#fff;

	subgraph Legend["Legend"]
		direction LR
		L1["Context"]
		L2["Agent"]
		L3["Workflow"]
		L4["MCP"]
		L5["Report"]
		L6["Config"]
		style Legend fill:#fff,stroke:#888,stroke-width:1px
		style L1 fill:#64748b,color:#fff
		style L2 fill:#f97316,color:#fff
		style L3 fill:#16a34a,color:#fff
		style L4 fill:#2563eb,color:#fff
		style L5 fill:#facc15,color:#222
		style L6 fill:#2563eb,color:#fff
	end

